#!/bin/bash
#
# Appears to be unused for nearly two years:
#
# bridgedb@ponticum:/srv/bridges.torproject.org$ stat bin/store-bridge-tarball
#   File: `bin/store-bridge-tarball'
#   Size: 453             Blocks: 8          IO Block: 4096   regular file
# Device: fe20h/65056d    Inode: 131340      Links: 1
# Access: (0755/-rwxr-xr-x)  Uid: ( 1531/bridgedb)   Gid: ( 1531/bridgedb)
# Access: 2014-01-12 04:37:09.525531184 +0000
# Modify: 2012-04-12 10:59:32.454819247 +0000
# Change: 2012-04-12 10:59:32.454819247 +0000
#  Birth: -

set -e
set -u

TS=$( TZ=UTC date +"%FT%H%M%SZ" )

STORE="/srv/bridges.torproject.org/from-authority-bridge-directories"
TARGET="/srv/bridges.torproject.org/from-authority"
FN="from-tonga-$TS.tar.gz"

cd "$STORE"
t=$(tempfile -d ".")
trap "rm -f '$t'" EXIT
cat > "$t"
ln "$t" "$FN"
rm -f "$t"
trap - EXIT

l="from-tonga-latest.tar.gz"
rm -f "$l.new"
ln "$FN" "$l.new"
mv "$l.new" "$l"

cd "$TARGET"
tar xzf "$STORE/$FN"

~/bin/sync-to-yatei
